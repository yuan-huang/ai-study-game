# 甘露使用逻辑修改说明

## 修改概述

根据用户需求，修改了甘露使用逻辑，实现以下规则：
- 一个用户，对应一个学科，一个分类，只能有一个甘露（没有数量区分）
- 使用甘露时，清除对应学科-分类的所有甘露
- 恢复对应用户年级-学科-分类的所有花朵的血量
- 考虑遗忘曲线的血量计算规则

## 后端修改

### 1. GardenController.ts - useNectar方法重构

**文件路径:** `backend/src/controllers/GardenController.ts`

**修改内容:**
- 修改API参数：从 `{ userId, flowerId, nectarId, healingAmount }` 改为 `{ userId, subject, category }`
- 查找逻辑：查找用户年级-学科-分类对应的所有甘露和花朵
- 治疗逻辑：
  - 计算甘露总治疗力
  - 根据遗忘曲线计算花朵实际HP
  - 按需分配治疗力给每朵花
  - 使用完甘露后完全清除
- 返回详细的治疗结果，包括每朵花的治疗前后HP

### 2. 路由注释更新

**文件路径:** `backend/src/routes/garden.ts`

**修改内容:**
- 更新 `/api/garden/use-nectar` 路由的参数说明
- 修改描述为"使用甘露治疗对应学科分类的所有花朵"

## 前端修改

### 1. API接口更新

**文件路径:** `frontend/src/api/gardenApi.ts`

**修改内容:**
- 修改 `useNectar` 方法参数：从 `(userId, flowerId, nectarId, healingAmount?)` 改为 `(userId, subject, category)`
- 更新返回类型，包含详细的治疗结果信息

### 2. 甘露使用逻辑

**文件路径:** `frontend/src/scenes/garden/GardenScene.ts`

**修改内容:**
- 重构 `useNectar` 方法，调用新的API
- 显示详细的使用效果信息：
  - 消耗甘露数量和治疗力
  - 治疗的花朵数量
  - 总恢复的HP
  - 剩余未使用的治疗力（花朵已满血时）
- 更新甘露详情显示，增加治疗力和使用警告

### 3. 批量使用甘露功能

**修改内容:**
- 重构 `useAllNectars` 方法，使用async/await
- 逐个调用每种甘露的使用API
- 统计并显示总体使用效果

### 4. 甘露提示信息优化

**修改内容:**
- 在甘露详情弹框中添加总治疗力显示
- 添加"使用后将清除此甘露"的警告提示
- 优化悬浮提示框，显示更完整的信息

## 血量计算规则

使用 `FlowerMemoryService.calculateFlowerHP(flower)` 计算花朵的实际HP，这个方法考虑了：
- 遗忘曲线的影响
- 最后治疗时间
- 花朵的学习记录

## 使用流程

1. 用户点击甘露"使用"按钮
2. 前端调用 `gardenApi.useNectar(userId, subject, category)`
3. 后端根据用户年级查找对应的甘露和花朵
4. 计算每朵花的实际HP（应用遗忘曲线）
5. 按需分配治疗力，优先给HP低的花朵
6. 删除所有对应的甘露
7. 返回详细的治疗结果
8. 前端显示治疗效果并刷新界面

## 注意事项

- 甘露使用后会被完全清除，不会留下部分剩余
- 如果花朵已满血，多余的治疗力会被浪费
- 治疗按花朵顺序进行，直到治疗力用完或所有花朵满血
- 支持同时治疗多朵同学科同分类的花朵

## 相关文件列表

### 后端文件
- `backend/src/controllers/GardenController.ts` - 主要逻辑修改
- `backend/src/routes/garden.ts` - 路由注释更新

### 前端文件
- `frontend/src/api/gardenApi.ts` - API接口更新
- `frontend/src/scenes/garden/GardenScene.ts` - UI逻辑修改

## 测试建议

1. 测试单个甘露使用功能
2. 测试批量甘露使用功能
3. 测试花朵已满血时的甘露使用
4. 测试遗忘曲线对治疗的影响
5. 测试甘露使用后的界面刷新 
# 花园系统奖励机制说明

## 🎮 塔防游戏奖励机制

### 奖励规则
我们的花园系统完全基于塔防游戏的奖励机制：

#### 1. 首次通关奖励 - 花朵 🌺
```typescript
// 首次通过某个学科+年级+分类组合时
if (completionCount === 1) {
  const flower = new Flower({
    userId: new mongoose.Types.ObjectId(userId),
    subject,        // 例如: 'math', 'chinese', 'english'
    grade: parseInt(grade),      // 年级: 1-12
    category,       // 分类: 例如 '几何', '代数', '古诗词'
    hp: 100,        // 初始生命值
    maxHp: 100,     // 最大生命值
    isPlanted: false // 初始状态：在仓库中，未种植
  });
}
```

#### 2. 再次通关奖励 - 甘露 💧
```typescript
// 再次通过同一组合时
else {
  const nectar = new Nectar({
    userId: new mongoose.Types.ObjectId(userId),
    subject,
    grade: parseInt(grade),
    category,
    healingPower: 1  // 治疗力度
  });
}
```

## 🌺 花园系统状态管理

### 花朵状态
每朵花朵有两种状态：

#### 1. 仓库状态 (`isPlanted: false`)
- 📦 存放在仓库工具栏中
- 🎯 可以拖拽到花园中种植
- 🏷️ 显示"来自塔防奖励"标签
- ⚡ 随时可以种植

#### 2. 种植状态 (`isPlanted: true`)
- 🌱 已种植在花园网格中
- 📍 有固定的花园位置 `(x, y)`
- ✅ 显示"已种植"状态标签
- 🔄 可以收获回仓库或移动位置
- 💊 可以使用甘露治疗

### 数据流程图

```
塔防游戏通关
      ↓
  获得奖励
      ↓
┌─────────────────┬─────────────────┐
│   首次通关      │   再次通关      │
│  奖励花朵 🌺    │  奖励甘露 💧    │
└─────────────────┴─────────────────┘
      ↓                    ↓
   花朵仓库              甘露库存
      ↓                    ↓
   拖拽种植              拖拽治疗
      ↓                    ↓
   花园展示              恢复HP
```

## 🎯 花园界面设计

### 界面布局
```
┌─────────────────────────────────────────────────┐
│                  🌺 知识花园                     │
│        🎮 通关塔防游戏获得花朵奖励               │
├─────────────────────────────────────────────────┤
│                                        📊统计  │
│  🌱🌱🌱🌱🌱🌱🌱🌱🌱🌱     │
│  🌱🌱🌱🌱🌱🌱🌱🌱🌱🌱     │ 💧甘露
│  🌱🌱🌱🌱🌱🌱🌱🌱🌱🌱     │ 工具
│  🌱🌱🌱🌱🌱🌱🌱🌱🌱🌱     │ 栏
│  🌱🌱🌱🌱🌱🌱🌱🌱🌱🌱     │
│  🌱🌱🌱🌱🌱🌱🌱🌱🌱🌱     │
├─────────────────────────────────────────────────┤
│ 🌸 仓库: [花朵工具栏 - 来自塔防奖励]           │
└─────────────────────────────────────────────────┘
```

### 区域说明

#### 1. 顶部信息区
- 🎯 **标题**: "知识花园"
- 📝 **说明**: "通关塔防游戏获得花朵奖励"
- 📊 **统计**: 显示花园利用率和总体数据

#### 2. 中央种植区 (10×8 网格)
- 🌱 **网格布局**: 80个种植位置
- ✅ **已种植花朵**: 显示状态标签和HP条
- 🎯 **拖拽目标**: 可以从工具栏拖拽花朵到此

#### 3. 右侧甘露工具栏
- 💧 **甘露展示**: 按学科分类显示
- 🏷️ **数量统计**: 显示每种甘露的总数
- 🎯 **拖拽治疗**: 可以拖拽到花朵上治疗

#### 4. 底部花朵工具栏
- 🌸 **仓库花朵**: 只显示未种植的花朵
- 🏷️ **来源标签**: "来自塔防奖励"
- 📊 **状态显示**: "仓库: X朵花可种植"

## 🔄 交互流程

### 1. 种植流程
```
1. 从塔防游戏获得花朵 → 花朵进入仓库 (isPlanted: false)
2. 花朵显示在底部工具栏
3. 拖拽花朵到花园网格
4. 调用种植API → 更新数据库 (isPlanted: true, 设置位置)
5. 花朵从工具栏消失，在花园中显示
```

### 2. 治疗流程
```
1. 从塔防游戏获得甘露 → 甘露进入库存
2. 甘露显示在右侧工具栏
3. 拖拽甘露到已种植花朵
4. 调用治疗API → 消耗甘露，恢复花朵HP
5. 更新花朵显示和甘露数量
```

### 3. 收获流程
```
1. 点击已种植花朵 → 显示操作菜单
2. 选择"收获" → 调用收获API
3. 花朵从花园消失，回到仓库 (isPlanted: false)
4. 花朵重新显示在底部工具栏
```

## 🎯 状态识别机制

### 花朵状态判断
```typescript
// 后端数据库查询
const flowers = await Flower.find({ userId });

// 前端状态分类
const plantedFlowers = flowers.filter(f => f.isPlanted);     // 花园中的
const warehouseFlowers = flowers.filter(f => !f.isPlanted); // 工具栏中的
```

### 界面状态显示
```typescript
// 已种植花朵
if (flower.isPlanted) {
  // 显示在花园网格中
  // 标签: "✅ 已种植"
  // 显示HP条和位置信息
}

// 仓库花朵
if (!flower.isPlanted) {
  // 显示在底部工具栏
  // 标签: "来自塔防奖励"
  // 可拖拽种植
}
```

## 📊 数据统计

### 花园统计信息
```typescript
interface GardenStats {
  totalFlowers: number;           // 总花朵数
  plantedFlowersCount: number;    // 已种植数量
  warehouseFlowersCount: number;  // 仓库数量
  totalNectars: number;           // 总甘露数
  gardenUtilization: number;      // 花园利用率 (0-100%)
  flowersBySubject: Record<string, any>; // 按学科统计
  nectarsBySubject: Record<string, any>; // 甘露按学科统计
}
```

### 实时状态显示
- 📊 **花园统计**: 实时显示在界面右上角
- 🌸 **工具栏状态**: "仓库: X朵花可种植"
- 💧 **甘露状态**: "甘露总数: X"
- 🎯 **利用率**: "花园利用率: X%"

## 🎮 与塔防游戏的关联

### 奖励触发时机
1. **塔防通关** → `TowerDefenseController.saveGameRecordAndGenerateReward()`
2. **检查通关次数** → 判断是首次还是再次通关
3. **生成对应奖励** → 花朵或甘露
4. **保存到数据库** → `Flower` 或 `Nectar` 表
5. **花园系统获取** → `GardenController.getGardenWarehouseItems()`

### 学科关联性
```typescript
// 塔防游戏参数
{
  subject: 'math',     // 学科
  grade: 4,            // 年级
  category: '几何'     // 分类
}

// 对应花朵/甘露
{
  subject: 'math',     // 相同学科
  grade: 4,            // 相同年级
  category: '几何'     // 相同分类
}
```

## ✅ 核心特性

### 1. 完整的奖励追踪
- ✅ 花朵来源明确标识
- ✅ 甘露获取路径清晰
- ✅ 状态变化实时更新

### 2. 直观的状态管理
- ✅ 视觉区分已种植/未种植
- ✅ 清晰的界面布局
- ✅ 实时的数据同步

### 3. 流畅的交互体验
- ✅ 拖拽种植操作
- ✅ 拖拽治疗功能
- ✅ 一键收获管理

### 4. 智能的数据展示
- ✅ 分类统计信息
- ✅ 利用率计算
- ✅ 奖励来源说明

---

## 🎯 总结

花园系统现在完全基于塔防游戏的奖励机制：

1. **🎮 塔防通关** → 获得花朵/甘露奖励
2. **📦 仓库管理** → 花朵进入工具栏，甘露进入甘露栏
3. **🌱 种植系统** → 拖拽种植，状态清晰标识
4. **💧 治疗系统** → 甘露恢复花朵HP
5. **📊 统计展示** → 实时数据和利用率

用户可以清楚地看到：
- 哪些花朵是通过塔防游戏获得的
- 哪些花朵已经种植，哪些还在仓库中
- 甘露的数量和来源
- 花园的整体状态和利用情况

这样就实现了完整的"通关获奖励 → 花园种植管理"的游戏循环！🌺 
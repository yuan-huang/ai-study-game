# 🌟 血量衰退系统重新设计说明

## 概述

基于用户反馈，我们重新设计了花朵血量衰退系统，实现了更合理的血量管理机制。

## 核心设计原则

### 1. 🕐 24小时更新规则
- **核心规则**：只有超过24小时才能触发血量更新
- **时间基准**：取花朵的创建时间、更新时间、血量更新时间、治疗时间、种植时间中的最大值
- **更新条件**：只有当最新时间戳距离当前时间超过24小时，才允许血量衰减

### 2. 💧 甘露使用逻辑
- **直接恢复**：使用甘露直接将花朵HP恢复到100（满血）
- **不涉及衰退**：甘露使用不考虑遗忘曲线，直接治疗
- **甘露清空**：使用后清空对应学科-年级-分类的所有甘露

## 技术实现

### FlowerBloodManager 优化

#### 新增方法
```typescript
// 获取花朵最新时间戳
private static getLatestTimestamp(flower: IFlower): Date {
  const timestamps = [
    flower.createdAt,
    flower.updatedAt, 
    flower.lastUpdatedAt,
    flower.lastHealedAt,
    flower.plantedAt
  ].filter(Boolean);
  
  return new Date(Math.max(...timestamps.map(date => date!.getTime())));
}
```

#### 重新设计的更新条件检查
```typescript
// 检查每朵花是否满足24小时更新条件
for (const flower of flowers) {
  const latestTimestamp = this.getLatestTimestamp(flower);
  const hoursSinceLatest = (currentTime.getTime() - latestTimestamp.getTime()) / (1000 * 60 * 60);

  // 只有超过24小时的花朵才能被更新
  if (hoursSinceLatest >= 24) {
    eligibleFlowers++;
    // 进一步检查血量危险程度...
  }
}
```

### 优先级系统

基于24小时规则和血量状态的新优先级：

- **Critical**: 满足24小时条件 + 血量低于20%
- **High**: 满足24小时条件 + 血量低于50%  
- **Medium**: 满足24小时条件 + 血量50%以上
- **Low**: 未满足24小时条件

### 甘露治疗机制

```typescript
// 直接恢复到100HP
flower.hp = 100;
flower.lastHealedAt = new Date();
await flower.save();

// 清空对应甘露
await Nectar.deleteMany({
  userId: userId,
  subject: subject,
  grade: userGrade,
  category: category
});
```

## API 接口变化

### getSubjectFlowerStatus 接口
- **默认行为**：使用虚拟血量计算，不更新数据库
- **强制更新**：添加 `?forceUpdate=true` 参数可强制更新
- **自动更新**：只有满足24小时条件时才自动更新数据库

### 新增血量管理接口
- `getOptimizedFlowersBloodStatus` - 获取详细血量状态
- `smartUpdateFlowersBlood` - 智能批量更新
- `batchUpdateFlowersBlood` - 条件批量更新

## 用户体验改进

### 查询行为优化
- ✅ **解决问题**：查询时不再自动扣血
- ✅ **简化显示**：直接显示数据库存储的血量
- ✅ **按需更新**：只有满足24小时条件时才同步数据库

### 血量衰退逻辑
- ✅ **时间控制**：严格的24小时间隔控制
- ✅ **多时间戳**：考虑所有相关时间点，取最新值
- ✅ **智能判断**：根据血量状态动态调整优先级

### 甘露使用体验
- ✅ **简单直接**：使用甘露直接满血，无复杂计算
- ✅ **资源清理**：使用后自动清空对应甘露
- ✅ **即时生效**：治疗后立即生效，重置时间戳

## 系统监控

### 日志输出优化
```
用户 12345 满足24小时更新条件: 3朵花已超过24小时未更新，其中1朵花处于危险血量 (优先级: critical)
用户 12345 暂无花朵满足24小时更新条件
```

### 血量状态跟踪
- 数据库HP vs 虚拟HP对比
- 24小时条件满足情况统计
- 危险血量花朵监控
- 甘露使用效果跟踪

## 配置参数

```typescript
AUTO_UPDATE_CONDITIONS: {
  REQUIRED_UPDATE_INTERVAL_HOURS: 24,  // 必须超过24小时才能更新
  CRITICAL_HP_THRESHOLD: 0.2           // 血量低于20%时优先级提升
}
```

## 使用建议

### 开发者
1. 使用 `getSubjectFlowerStatus` 进行常规查询
2. 需要强制同步时添加 `?forceUpdate=true`
3. 定期调用智能更新接口进行维护
4. 监控系统日志了解更新情况

### 用户体验
1. 查询花园状态不会导致血量损失
2. 系统每24小时自动衰减一次血量
3. 使用甘露可立即恢复花朵到满血状态
4. 合理安排学习节奏维护花朵健康

## 总结

这次重新设计完全解决了"每次查询都扣血"的问题，建立了基于时间控制的合理血量衰退机制。系统现在更加稳定可靠，用户体验得到显著改善。 